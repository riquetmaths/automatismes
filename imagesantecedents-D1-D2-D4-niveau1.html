<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QCM : Fonctions & Graphiques (2de)</title>
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            startup: { typeset: false }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://unpkg.com/d3@3/d3.min.js"></script>
    <script src="https://unpkg.com/function-plot@1/dist/function-plot.js"></script>
    <style>
        :root {
            --primary: #4F46E5;
            --secondary: #6B7280;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --bg: #F3F4F6;
            --card: #ffffff;
            --text: #1F2937;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            background: var(--card);
            width: 100%;
            max-width: 900px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            overflow: hidden;
            padding: 30px;
        }

        header { text-align: center; margin-bottom: 25px; }
        h1 { color: var(--primary); font-size: 1.8rem; margin: 0 0 10px 0; }

        .progress-container {
            background-color: #e5e7eb;
            border-radius: 99px;
            height: 8px;
            width: 100%;
            margin-bottom: 15px;
            overflow: hidden;
        }
        .progress-bar {
            background-color: var(--primary);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        /* --- ZONE VISUELLE --- */
        .visual-container {
            width: 100%;
            height: 350px;
            margin: 0 auto 25px auto;
            border: 2px solid #333;
            border-radius: 12px;
            background: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
        }

        /* Styles Function-Plot */
        .function-plot .grid .tick line { stroke: #e5e7eb !important; stroke-width: 1px !important; opacity: 1 !important; }
        .function-plot .axis path.domain { stroke: #000 !important; stroke-width: 2.5px !important; }
        .function-plot .axis .tick line { stroke: #000 !important; stroke-width: 2px !important; }
        .function-plot .axis text { fill: #000 !important; font-size: 14px !important; font-weight: bold; }

        /* Styles TABLEAU DE VARIATION */
        .tv-wrapper { width: 100%; height: 100%; display: flex; flex-direction: column; font-family: 'Segoe UI', sans-serif; }
        .tv-row { display: grid; grid-template-columns: 90px 1fr; border-bottom: 2px solid #333; width: 100%; }
        .tv-row:last-child { border-bottom: none; flex-grow: 1; }
        .tv-header { background: #f4f4f4; border-right: 2px solid #333; display: flex; align-items: center; justify-content: center; font-weight: bold; font-style: italic; font-size: 1.2rem; height: 100%; }
        .tv-data { display: flex; justify-content: space-between; align-items: center; padding: 0 40px; font-size: 1.2rem; font-weight: bold; }
        .tv-canvas-container { position: relative; width: 100%; height: 100%; overflow: hidden; }
        canvas { display: block; width: 100%; height: 100%; }

        /* --- INTERFACE QUIZ --- */
        .question-text { font-size: 1.25rem; font-weight: 600; margin-bottom: 20px; text-align: center; }
        .options-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
        @media (max-width: 600px) {
            .options-grid { grid-template-columns: 1fr; }
            .visual-container { height: 300px !important; }
        }

        .btn-option {
            background: white; border: 2px solid #e5e7eb; padding: 15px;
            border-radius: 12px; cursor: pointer; font-size: 1rem;
            transition: all 0.2s; text-align: left;
        }
        .btn-option:hover:not(:disabled) { border-color: var(--primary); background-color: #EEF2FF; }
        .btn-option.correct { background-color: #D1FAE5; border-color: var(--success); color: #065F46; }
        .btn-option.wrong { background-color: #FEE2E2; border-color: var(--danger); color: #991B1B; opacity: 0.7; }

        .feedback { padding: 15px; border-radius: 8px; margin-top: 15px; display: none; line-height: 1.5; }
        .feedback.hint { background-color: #FFFBEB; border-left: 5px solid var(--warning); color: #92400E; }
        .feedback.success { background-color: #D1FAE5; border-left: 5px solid var(--success); color: #065F46; }

        .controls { display: flex; justify-content: space-between; margin-top: 20px; height: 50px; }
        .btn-nav { color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 1rem; cursor: pointer; display: inline-block; }
        .btn-next { background-color: var(--primary); }
        .btn-next:hover { background-color: #4338ca; }
        .btn-prev { background-color: var(--secondary); display: none; }
        .btn-prev:hover { background-color: #4b5563; }

        .result-screen { text-align: center; display: none; padding: 40px 0; }
        .score-circle {
            width: 150px; height: 150px; border-radius: 50%;
            background: conic-gradient(var(--primary) 0%, #e5e7eb 0%);
            display: flex; justify-content: center; align-items: center;
            margin: 0 auto 30px auto;
        }
        .score-inner {
            width: 130px; height: 130px; background: white; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 2.5rem; font-weight: bold; color: var(--primary);
        }
        .btn-restart {
            background-color: var(--text); color: white; border: none;
            padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 1.1rem;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>üìà D1 D2 D4 Fonctions : Images & Ant√©c√©dents</h1>
        <div class="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div style="display:flex; justify-content:space-between; color: #6b7280; font-size: 0.9rem;">
            <span>Score: <strong id="current-score-display">0</strong></span>
            <span>Question <span id="current-q">1</span> / <span id="total-q"></span></span>
        </div>
    </header>

    <div id="quiz-area">
        <div class="question-text" id="question-text"></div>
        <div class="visual-container" id="visual-area"></div>
        <div class="options-grid" id="options-container"></div>
        <div class="feedback hint" id="hint-area"></div>
        <div class="feedback success" id="success-area"></div>
        <div class="controls">
            <button class="btn-nav btn-prev" id="btn-prev" onclick="prevQuestion()">‚Üê Pr√©c√©dent</button>
            <button class="btn-nav btn-next" id="btn-next" onclick="nextQuestion()">Question Suivante ‚Üí</button>
        </div>
    </div>

    <div id="result-area" class="result-screen">
        <h2>Quiz Termin√© !</h2>
        <p>Ton score final :</p>
        <div class="score-circle" id="score-circle">
            <div class="score-inner" id="final-score"></div>
        </div>
        <p id="comment-score" style="font-size: 1.2rem; margin-bottom: 30px;"></p>
        <button class="btn-restart" onclick="location.reload()">Recommencer le Quiz</button>
    </div>
</div>

<script>
    /* * DONN√âES DU QUIZ 
     * Comp√©tences : Lire image, Ant√©c√©dent, Appartenance, R√©soudre f(x)=k, f(x)<k
     */
    const quizData = [
        // QUESTION 1 : Image (Lecture graphique simple)
        {
            type: 'plot',
            question: "Quelle est l'image de $0$ par la fonction $f$ ?",
            plotConfig: {
                data: [
                    { fn: 'x^2 - 3', color: 'steelblue', attr: { "stroke-width": 4 } },
                    { points: [[0, -3]], fnType: 'points', graphType: 'scatter', color: 'black', attr: {r: 6}, isHint: true }
                ],
                yAxis: { domain: [-5, 5] },
                xAxis: { domain: [-4, 4] }
            },
            options: [
                { text: "$0$", correct: false },
                { text: "$-3$", correct: true },
                { text: "$3$", correct: false },
                { text: "Impossible", correct: false }
            ],
            hint: "üí° Regarde l'intersection de la courbe avec l'axe vertical (axe des ordonn√©es).",
            explanation: "L'image de $0$ se lit sur l'axe des ordonn√©es. La courbe passe par le point $(0 ; -3)$, donc $f(0) = -3$."
        },

        // QUESTION 2 : Ant√©c√©dent (Lecture graphique simple)
        {
            type: 'plot',
            question: "Quel est l'ant√©c√©dent de $2$ par cette fonction affine ?",
            plotConfig: {
                data: [
                    { fn: '0.5 * x + 1', color: 'steelblue', attr: { "stroke-width": 4 } },
                    { fn: '2', color: 'tomato', attr: {'stroke-dasharray': '5,5', "stroke-width": 2}, isHint: true },
                    { points: [[2, 2]], fnType: 'points', graphType: 'scatter', color: 'black', attr: {r: 6}, isHint: true }
                ],
                yAxis: { domain: [-1, 4] },
                xAxis: { domain: [-2, 6] }
            },
            options: [
                { text: "$1$", correct: false },
                { text: "$2$", correct: true },
                { text: "$0$", correct: false },
                { text: "$4$", correct: false }
            ],
            hint: "üí° Pars de $y=2$ sur l'axe vertical et rejoins la courbe horizontalement.",
            explanation: "On cherche $x$ tel que $f(x)=2$. Sur le graphique, le point d'ordonn√©e 2 a pour abscisse 2."
        },

        // QUESTION 3 : Appartenance d'un point (Vrai)
        {
            type: 'plot',
            question: "Le point $A(-2 ; 4)$ appartient-il √† la courbe de $f(x) = x^2$ ?",
            plotConfig: {
                data: [
                    { fn: 'x^2', color: 'steelblue', attr: { "stroke-width": 4 } },
                    { points: [[-2, 4]], fnType: 'points', graphType: 'scatter', color: 'purple', attr: {r: 7}, isHint: true }
                ],
                yAxis: { domain: [-1, 6] },
                xAxis: { domain: [-4, 4] }
            },
            options: [
                { text: "Oui", correct: true },
                { text: "Non", correct: false },
                { text: "On ne peut pas savoir", correct: false },
                { text: "Seulement si x > 0", correct: false }
            ],
            hint: "üí° V√©rifie par le calcul : remplace $x$ par $-2$ dans la formule $x^2$.",
            explanation: "On calcule $f(-2) = (-2)^2 = 4$. Comme l'ordonn√©e du point est bien 4, le point appartient √† la courbe."
        },

        // QUESTION 4 : R√©soudre f(x) = k (2 solutions)
        {
            type: 'plot',
            question: "R√©soudre graphiquement l'√©quation $f(x) = -3$.",
            plotConfig: {
                data: [
                    { fn: 'x^2 - 4', color: 'steelblue', attr: { "stroke-width": 4 } },
                    { fn: '-3', color: 'tomato', attr: {'stroke-dasharray': '5,5', "stroke-width": 2}, isHint: true },
                    { points: [[-1, -3], [1, -3]], fnType: 'points', graphType: 'scatter', color: 'red', attr: {r: 6}, isHint: true }
                ],
                yAxis: { domain: [-5, 2] },
                xAxis: { domain: [-3, 3] }
            },
            options: [
                { text: "$S = \\{-3\\}$", correct: false },
                { text: "$S = \\{1\\}$", correct: false },
                { text: "$S = \\{-1 ; 1\\}$", correct: true },
                { text: "$S = \\emptyset$", correct: false }
            ],
            hint: "üí° Trace mentalement une ligne horizontale √† la hauteur -3. Combien de fois coupe-t-elle la courbe ?",
            explanation: "La droite d'√©quation $y=-3$ coupe la parabole en deux points d'abscisses $-1$ et $1$."
        },

        // QUESTION 5 : In√©quation f(x) < k (Intervalle)
        {
            type: 'plot',
            question: "R√©soudre l'in√©quation $f(x) < 1$.",
            plotConfig: {
                data: [
                    { fn: 'x - 1', color: 'steelblue', attr: { "stroke-width": 4 } },
                    { fn: 'x - 1', range: [-5, 2], color: 'rgba(239, 68, 68, 0.2)', closed: true, isHint: true },
                    { fn: '1', color: 'black', attr: {'stroke-dasharray': '5,5'}, isHint: true }
                ],
                yAxis: { domain: [-3, 4] },
                xAxis: { domain: [-2, 5] }
            },
            options: [
                { text: "$S = ]-\\infty ; 2[$", correct: true },
                { text: "$S = ]2 ; +\\infty[$", correct: false },
                { text: "$S = [1 ; +\\infty[$", correct: false },
                { text: "$S = ]-\\infty ; 1[$", correct: false }
            ],
            hint: "üí° Pour quelles valeurs de $x$ la courbe bleue est-elle EN DESSOUS de la ligne pointill√©e $y=1$ ?",
            explanation: "La droite coupe $y=1$ en $x=2$. La courbe est en dessous de 1 pour toutes les valeurs √† gauche de 2, soit $S = ]-\\infty ; 2[$."
        },

        // QUESTION 6 : Image avec fonction inverse (Hyperbole)
        {
            type: 'plot',
            question: "Quelle est l'image de $-2$ par la fonction inverse $f(x) = \\frac{1}{x}$ ?",
            plotConfig: {
                data: [
                    { fn: '1/x', color: 'steelblue', attr: { "stroke-width": 4 }, skipTip: true },
                    { points: [[-2, -0.5]], fnType: 'points', graphType: 'scatter', color: 'black', attr: {r: 6}, isHint: true }
                ],
                yAxis: { domain: [-3, 3] },
                xAxis: { domain: [-4, 4] }
            },
            options: [
                { text: "$-2$", correct: false },
                { text: "$-0,5$", correct: true },
                { text: "$0,5$", correct: false },
                { text: "$2$", correct: false }
            ],
            hint: "üí° Place-toi en $x=-2$ et regarde l'ordonn√©e.",
            explanation: "$f(-2) = \\frac{1}{-2} = -0,5$."
        },

        // QUESTION 7 : Ant√©c√©dent impossible (f(x) = k sans solution)
        {
            type: 'plot',
            question: "Combien d'ant√©c√©dents le nombre $-1$ poss√®de-t-il par la fonction $f(x)=x^2$ ?",
            plotConfig: {
                data: [
                    { fn: 'x^2', color: 'steelblue', attr: { "stroke-width": 4 } },
                    { fn: '-1', color: 'tomato', attr: {'stroke-dasharray': '5,5'}, isHint: true }
                ],
                yAxis: { domain: [-2, 4] },
                xAxis: { domain: [-3, 3] }
            },
            options: [
                { text: "0", correct: true },
                { text: "1", correct: false },
                { text: "2", correct: false },
                { text: "Une infinit√©", correct: false }
            ],
            hint: "üí° La courbe descend-elle jusqu'√† la hauteur -1 ?",
            explanation: "La fonction carr√© $x^2$ est toujours positive ou nulle. Elle ne descend jamais √† $-1$. L'√©quation $x^2 = -1$ n'a pas de solution r√©elle."
        },

        // QUESTION 8 : Appartenance d'un point (Faux & Pi√®ge tr√®s serr√©)
        // MODIFICATION : f(x)=0.4x+1. Point M(2;2). f(2)=1.8. Ecart = 0.2 (1/5e carreau)
        {
            type: 'plot',
            question: "Le point $M(2 ; 2)$ appartient-il √† la courbe de $f(x) = 0,4x + 1$ ?",
            plotConfig: {
                data: [
                    { fn: '0.4*x + 1', color: 'steelblue', attr: { "stroke-width": 4 } },
                    // Le point M(2, 2) est masqu√© par d√©faut
                    { points: [[2, 2]], fnType: 'points', graphType: 'scatter', color: 'red', attr: {r: 6}, isHint: true }
                ],
                yAxis: { domain: [-1, 5] },
                xAxis: { domain: [-1, 6] }
            },
            options: [
                { text: "Oui", correct: false },
                { text: "Non", correct: true },
                { text: "Oui, il est sur la droite", correct: false },
                { text: "On ne peut pas savoir", correct: false }
            ],
            hint: "üí° Attention, ne te fie pas seulement √† tes yeux ! V√©rifie par le calcul : calcule $f(2)$.",
            explanation: "Graphiquement, le point semble sur la droite, l'√©cart est infime (0,2).<br>Mais calculons : $f(2) = 0,4 \\times 2 + 1 = 0,8 + 1 = 1,8$.<br>Or le point $M$ a pour ordonn√©e $2$. Comme $1,8 \\neq 2$, le point n'appartient pas √† la courbe."
        },

        // QUESTION 9 : In√©quation f(x) >= 0 (Signe de la fonction)
        {
            type: 'plot',
            question: "Sur quel intervalle a-t-on $f(x) \\ge 0$ ?",
            plotConfig: {
                data: [
                    { fn: '-x^2 + 4', color: 'steelblue', attr: { "stroke-width": 4 } },
                    { fn: '-x^2 + 4', range: [-2, 2], color: 'rgba(16, 185, 129, 0.2)', closed: true, isHint: true }
                ],
                yAxis: { domain: [-2, 5] },
                xAxis: { domain: [-4, 4] }
            },
            options: [
                { text: "$]-\\infty ; -2]$", correct: false },
                { text: "$]-2 ; 2[$", correct: false }, // Le pi√®ge
                { text: "$[-2 ; 2]$", correct: true },
                { text: "$[2 ; +\\infty[$", correct: false }
            ],
            hint: "üí° Attention au sens des crochets : l'in√©galit√© est large (ou √©gale).",
            explanation: "La parabole est au-dessus ou sur l'axe entre $-2$ et $2$. Comme on demande $\\ge 0$, on prend les valeurs o√π √ßa vaut $0$, donc les crochets sont ferm√©s."
        },

        // QUESTION 10 : √âquation f(x) = k (Valeur n√©gative)
        {
            type: 'plot',
            question: "R√©soudre l'√©quation $f(x) = -8$ pour la fonction $f(x) = x^3$.",
            plotConfig: {
                data: [
                    { fn: 'x^3', color: 'steelblue', attr: { "stroke-width": 4 } },
                    { fn: '-8', color: 'tomato', attr: {'stroke-dasharray': '5,5'}, isHint: true },
                    { points: [[-2, -8]], fnType: 'points', graphType: 'scatter', color: 'red', attr: {r: 6}, isHint: true }
                ],
                // On agrandit l'axe Y pour voir -8
                yAxis: { domain: [-10, 5] },
                xAxis: { domain: [-3, 3] }
            },
            options: [
                { text: "$x = -2$", correct: true },
                { text: "$x = 2$", correct: false },
                { text: "$x = -8$", correct: false },
                { text: "Pas de solution", correct: false }
            ],
            hint: "üí° Trace une ligne horizontale √† la hauteur -8. Quel est l'abscisse du point d'intersection ?",
            explanation: "Le nombre dont le cube est $-8$ est $-2$ (car $(-2) \\times (-2) \\times (-2) = -8$)."
        }
    ];

    let currentQIndex = 0;
    let score = 0;
    let hasFailedCurrent = false;
    let areHintsVisible = false;

    // Mise √† jour du compteur total
    document.getElementById('total-q').innerText = quizData.length;

    function typesetMath() {
        if (window.MathJax) MathJax.typesetPromise().catch(err => console.log(err));
    }

    function loadQuestion() {
        const qData = quizData[currentQIndex];
        hasFailedCurrent = false;
        areHintsVisible = false;

        // UI Text
        document.getElementById('question-text').innerHTML = qData.question;
        document.getElementById('current-q').innerText = currentQIndex + 1;
        document.getElementById('progress-bar').style.width = ((currentQIndex) / quizData.length * 100) + "%";

        // Reset Feedback
        document.getElementById('hint-area').style.display = 'none';
        document.getElementById('success-area').style.display = 'none';

        // GESTION DES BOUTONS DE NAVIGATION
        const nextBtn = document.getElementById('btn-next');
        nextBtn.style.display = 'block';
        if (currentQIndex === quizData.length - 1) {
            nextBtn.innerText = "Voir les r√©sultats üèÜ";
        } else {
            nextBtn.innerText = "Question Suivante ‚Üí";
        }

        const prevBtn = document.getElementById('btn-prev');
        if (currentQIndex > 0) {
            prevBtn.style.display = 'block';
        } else {
            prevBtn.style.display = 'none';
        }

        // G√©n√©ration Options
        const optsDiv = document.getElementById('options-container');
        optsDiv.innerHTML = "";
        qData.options.forEach((opt, idx) => {
            const btn = document.createElement('button');
            btn.className = 'btn-option';
            btn.innerHTML = `<strong>${String.fromCharCode(65+idx)})</strong>&nbsp; ${opt.text}`;
            btn.onclick = () => checkAnswer(opt, btn);
            optsDiv.appendChild(btn);
        });

        // RENDU VISUEL (Plot ou Table)
        const visualArea = document.getElementById('visual-area');
        visualArea.innerHTML = ''; 
        
        if(qData.type === 'plot') {
            setTimeout(() => renderFunctionPlot(qData.plotConfig, false), 50);
        } else if (qData.type === 'table') {
            setTimeout(() => renderTable(qData.tableConfig, false), 50);
        }

        typesetMath();
    }

    // --- MOTEUR GRAPHIQUE ---
    function renderFunctionPlot(config, showHints) {
        const filteredData = config.data.filter(item => showHints ? true : !item.isHint);
        const width = document.getElementById('visual-area').clientWidth;
        const height = document.getElementById('visual-area').clientHeight;

        functionPlot(Object.assign({}, config, {
            target: '#visual-area',
            width: width,
            height: height,
            grid: true,
            disableZoom: false,
            data: filteredData
        }));
    }

    // --- MOTEUR TABLEAU DE VARIATION ---
    function renderTable(config, showHints) {
        const container = document.getElementById('visual-area');
        let xHTML = "";
        config.x.forEach(val => xHTML += `<span>${val}</span>`);

        const html = `<div class="tv-wrapper">
                        <div class="tv-row" style="height: 70px;"> 
                            <div class="tv-header">x</div>
                            <div class="tv-data" id="rowX">${xHTML}</div>
                        </div>
                        <div class="tv-row">
                            <div class="tv-header">f(x)</div>
                            <div class="tv-canvas-container">
                                <canvas id="tvCanvas"></canvas>
                            </div>
                        </div>
                      </div>`;
        container.innerHTML = html;
        setTimeout(() => drawTableCanvas(config, showHints), 50);
    }

    function drawTableCanvas(config, showHints) {
        const canvas = document.getElementById('tvCanvas');
        if(!canvas) return;
        
        const container = canvas.parentElement;
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;

        const ctx = canvas.getContext('2d');
        const rowX = document.getElementById('rowX');
        
        ctx.font = "bold 20px 'Segoe UI', sans-serif";
        ctx.lineWidth = 2.5;
        ctx.strokeStyle = "#333";

        const spans = rowX.querySelectorAll('span');
        const coords = [];
        const centerY = canvas.height / 2;
        const gap = Math.min((canvas.height / 2) - 30, 80); 

        // R√©cup√©rer le rectangle du canvas par rapport au viewport
        const canvasRect = canvas.getBoundingClientRect();

        spans.forEach((span, i) => {
            const spanRect = span.getBoundingClientRect();
            // Calculer la position X relative au canvas
            const centerX = (spanRect.left + spanRect.width / 2) - canvasRect.left;
            
            const isHigh = config.fx[i].type === 'max';
            coords.push({
                x: centerX,
                y: isHigh ? centerY - gap : centerY + gap,
                val: config.fx[i].val,
                isTarget: config.fx[i].isTarget
            });
        });

        const arrowMargin = 25;
        for (let i = 0; i < coords.length - 1; i++) {
            const start = coords[i];
            const end = coords[i+1];
            let currentMargin = arrowMargin;
            
            const dist = end.x - start.x;
            if (dist < (arrowMargin * 2 + 10)) currentMargin = dist / 2 - 5;

            ctx.beginPath();
            ctx.moveTo(start.x + currentMargin, start.y);
            ctx.lineTo(end.x - currentMargin, end.y);
            ctx.stroke();
            drawArrowHead(ctx, start.x + currentMargin, start.y, end.x - currentMargin, end.y);
        }

        coords.forEach(p => {
            ctx.fillStyle = "#000";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(p.val, p.x, p.y);

            if(showHints && p.isTarget) {
                ctx.beginPath();
                ctx.strokeStyle = "red";
                ctx.lineWidth = 3;
                ctx.arc(p.x, p.y, 25, 0, 2 * Math.PI);
                ctx.stroke();
                ctx.strokeStyle = "#333";
            }
        });
    }

    function drawArrowHead(ctx, x1, y1, x2, y2) {
        const headLength = 12;
        const angle = Math.atan2(y2 - y1, x2 - x1);
        ctx.beginPath();
        ctx.moveTo(x2, y2);
        ctx.lineTo(x2 - headLength * Math.cos(angle - Math.PI / 6), y2 - headLength * Math.sin(angle - Math.PI / 6));
        ctx.moveTo(x2, y2);
        ctx.lineTo(x2 - headLength * Math.cos(angle + Math.PI / 6), y2 - headLength * Math.sin(angle + Math.PI / 6));
        ctx.stroke();
    }

    // --- JEU ---
    function checkAnswer(optionData, btnElement) {
        const hintArea = document.getElementById('hint-area');
        const successArea = document.getElementById('success-area');
        const qData = quizData[currentQIndex];

        if (optionData.correct) {
            btnElement.classList.add('correct');
            document.querySelectorAll('.btn-option').forEach(b => b.disabled = true);
            hintArea.style.display = 'none';
            successArea.innerHTML = `<strong>‚úÖ Bravo !</strong><br>${qData.explanation}`;
            successArea.style.display = 'block';
            typesetMath();

            if (!hasFailedCurrent) {
                score++;
                document.getElementById('current-score-display').innerText = score;
            }

            areHintsVisible = true;
            refreshVisual(true);
        } else {
            hasFailedCurrent = true;
            btnElement.classList.add('wrong');
            btnElement.disabled = true;
            hintArea.innerHTML = qData.hint;
            hintArea.style.display = 'block';
            areHintsVisible = true;
            refreshVisual(true);
            typesetMath();
        }
    }

    function refreshVisual(showHints) {
        const qData = quizData[currentQIndex];
        if(qData.type === 'plot') renderFunctionPlot(qData.plotConfig, showHints);
        else if(qData.type === 'table') drawTableCanvas(qData.tableConfig, showHints); 
    }

    function nextQuestion() {
        if (currentQIndex < quizData.length - 1) {
            currentQIndex++;
            loadQuestion();
        } else {
            showResults();
        }
    }

    function prevQuestion() {
        if (currentQIndex > 0) {
            currentQIndex--;
            loadQuestion();
        }
    }

    function showResults() {
        document.getElementById('quiz-area').style.display = 'none';
        document.getElementById('result-area').style.display = 'block';
        document.getElementById('final-score').innerText = `${score}`;
        document.getElementById('progress-bar').style.width = "100%";
        
        const percentage = (score / quizData.length) * 100;
        document.getElementById('score-circle').style.background = 
            `conic-gradient(var(--primary) ${percentage}%, #e5e7eb ${percentage}%)`;

        let comment = "";
        if(score === quizData.length) comment = "ü•á Parfait !";
        else if(score >= 8) comment = "ü•à Tr√®s bien !";
        else if(score >= 5) comment = "ü•â Pas mal.";
        else comment = "üí™ Courage !";
        
        document.getElementById('comment-score').innerText = comment;
    }

    window.addEventListener('resize', () => refreshVisual(areHintsVisible));
    window.onload = loadQuestion;
</script>

</body>
</html>
